<!-- /templates/mergedocs/PR.html  -->
{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}
{% import 'widgets.html' as widgets %}

{% block app_content %}
<form method="POST" action="{{ url_for('pr_bp.pr_save_send', method=method, rent_id=rent_pr.id) }}">
    <div class="form-group row flex-row-reverse">
        <div class="col-md-3">
            <a href="{{ url_for('pr_bp.pr_dialog', rent_id=rent_pr.id, action='view') }}"
               class="btn btn-block btn-tog button-icon arrow-left" role="button">back to pr selection</a>
        </div>
        <div class="col-md-9">
            <span>Choose address and edit the pay request</span>
        </div>
    </div>
    <div class="row">
        <div class="col-md-9">
            <div id="address_fields" style="margin-bottom:1rem;">
                {{ widgets.combobox(name="address_fields", id="address_fields", items=[rent_pr.mailaddr,
                (rent_pr.tenantname + ', ' + rent_pr.propaddrs[0].propaddr),
                ('The owner/occupier, ' + rent_pr.propaddrs[0].propaddr)], item_selected=rent_pr.mailaddr) }}
            </div>
            <div id="doc_html" contenteditable="false">
                <div id="manager_div" contenteditable="true">
                    <div class="font-size-large manager-name" align="center" style="font-size:12.5pt;">
                        <b>{{ rent_pr.landlord.manager.managername }}</b>
                    </div>
                    <div class="font-size-small manager-addr" align="center" style="font-size:9.5pt;">
                        {{ rent_pr.landlord.manager.manageraddr }}
                        <br/>
                        {{ rent_pr.landlord.manager.manageraddr2 }}
                        <br/>
                    </div>
                </div>
                <div class="font-size-medium" align="right" contenteditable="true" style="font-size:10.5pt;">
                    <span id="ref_span">Our Ref: {{ rent_pr.rentcode }}</span>
                    <br/>
                    Date: {{ today_date.strftime('%d-%b-%Y') }}
                </div>
                <div class="font-size-medium" align="left" style="font-size:10.5pt;">
					<span id="addr_span" class="block-text" contenteditable="true">
						{% set addr_list = rent_pr.mailaddr.split(',') %}
                        {% for item in addr_list %}
                            {{ item }}
                            <br/>
                        {% endfor %}
					</span>
                    <br/>
                    <br/>
                    <b><span id="subject_span" class="block-text" contenteditable="true" style="font-size:10.5pt;">
						{{ subject }}
					</span></b>
                    <br/>
                </div>
                <div class="font-size-medium" align="left" contenteditable="true">
                    <div id="owings_div">
                        <table class="pr_table" style="border-collapse: collapse;
                        width: 100%; border-radius: 5px; margin-left: auto; margin-right: auto;">
                            <colgroup>
                                <col style="width:80%;">
                                <col style="width:20%">
                            </colgroup>
                            <tr style="background-color: #86A9DC; color: white; font-weight: bold;">
                                <td style="width:80%; font-size:10.5pt; padding-top:5px; padding-left:5px;">Details</td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;">Amount
                                </td>
                            </tr>
                            {% if rent_pr.rent_gale %}
                            <tr>
                                <td style="width:80%; padding-top:5px; padding-left:5px; font-size:10.5pt;"><span>
                                    {{ rent_pr.freqdet.capitalize() }} {{ rent_pr.rent_type }} due and payable
                                    {{ rent_pr.advarrdet }} on {{ rent_pr.nextrentdate.strftime('%d-%b-%Y') }}:</span>
                                </td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;" class="amount_class">
                                    {{ money_str(rent_pr.rent_gale, pound=True) }}
                                </td>
                            </tr>
                            {% endif %}
                            {% if rent_pr.arrears %}
                            <tr>
                                <td style="width:80%; padding-top:5px; padding-left:5px; font-size:10.5pt;">Unpaid
                                    {{ rent_pr.rent_type }} is owing for the period
                                    {{ rent_pr.arrears_start_date.strftime('%d-%b-%Y') }} to
                                    {{ rent_pr.arrears_end_date.strftime('%d-%b-%Y') }}:
                                </td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;" class="amount_class">
                                    {{ money_str(rent_pr.arrears, pound=True) }}
                                </td>
                            </tr>
                            {% endif %}
                            {% if rent_pr.charges %}
                            {% for charge in rent_pr.charges %}
                            <tr>
                                <td style="width:80%; padding-top:5px; padding-left:5px; font-size:10.5pt;">
                                    {{ charge.chargetype.chargedesc.capitalize() }} added on
                                    {{ charge.chargestartdate.strftime('%d-%b-%Y') }}:
                                </td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;" class="amount_class">
                                    {{ money_str(charge.chargetotal, pound=True) }}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% if rent_pr.recovery_charge_amount > 0 %}
                            <tr>
                                <td style="width:80%; padding-top:5px; padding-left:5px; font-size:10.5pt;">
                                    Recovery costs added on {{ today_date.strftime('%d-%b-%Y') }}:
                                </td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;" class="amount_class">
                                    {{ money_str(rent_pr.recovery_charge_amount, pound=True) }}
                                </td>
                            </tr>
                            {% endif %}
                            <tr class="total" style="font-weight: bold; background-color:#e3e3e3;">
                                <td style="width:80%; padding-top:5px; padding-left:5px; font-size:10.5pt;">
                                    The total amount payable is:
                                </td>
                                <td style="width:20%; font-size:10.5pt; padding-top:5px; padding-right: 10px;
                                text-align: right;" class="amount_class">
                                    {{ money_str(rent_pr.rent_gale + rent_pr.arrears +
                                    rent_pr.totcharges, pound=True) }}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <style>
                        p
                        {
                            font-size: 10.5pt;
                        }
                    </style>
                    <p>{{ widgets.linebreaks_for_string(block) }}</p>
                    <p>
                    <hr class="hr-thick"/>
                    <div align="center">
                        <p>
                            <b>PAYMENT ADVICE - {{ today_date.strftime('%d-%b-%Y') }} - Ref: {{ rent_pr.rentcode }}</b>
                            <br/>
                            Please return this section with your payment
                        </p>
                    </div>
                    <p>
                        Please find enclosed my/our cheque/PO for {{
                        money_str(rent_pr.rent_gale + rent_pr.arrears + rent_pr.totcharges, pound=True) }}
                        to pay {{ rent_pr.rent_type }} from {% if rent_pr.arrears %}
                        {{ rent_pr.arrears_start_date.strftime('%d-%b-%Y') }} {% else %} {{
                        rent_pr.next_gale_start.strftime('%d-%b-%Y') }}
                        {% endif %} to {{ rent_pr.arrears_end_date_1.strftime('%d-%b-%Y') }}
                        {% if rent_pr.charges or (rent_pr.recovery_charge_amount > 0) %} plus other
                        charges as set out above {% endif %} (or {{ money_str(rent_pr.rent_gale +
                        rent_pr.rent_gale + rent_pr.arrears + rent_pr.totcharges, pound=True) }} if you wish to pay
                        an additional period of rent) for property:
                        {% for addr in rent_pr.propaddrs %}
                        {{ addr.propaddr }}
                        {% endfor %}
                    </p>
                    <br/>
                    <br/>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-white sticky-top">
                <div class="card-header">
                    <div class="row">
                        <div class="col"><span>Select an option below to send</span>
                        </div>
                    </div>
                </div>
                <div class="card-body text-primary">
                    <div class="form-group row" style="margin-bottom:0px;">
                        <div class="col">
                            <button type="submit"
                                    formaction="{{ url_for('pr_bp.pr_save_send', method='post', rent_id=rent_pr.id) }}"
                                    class="btn btn-block btn-success save_pr button-icon letter" role="button">post
                            </button>
                            <button type="submit"
                                    formaction="{{ url_for('pr_bp.pr_save_send', method='email and post', rent_id=rent_pr.id) }}"
                                    class="btn btn-block btn-success save_pr button-icon mail-ic" role="button">post and
                                email
                            </button>
                            <button type="submit"
                                    formaction="{{ url_for('pr_bp.pr_save_send', method='email', rent_id=rent_pr.id) }}"
                                    class="btn btn-block btn-success save_pr button-icon email-ic" role="button">email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-group row">
        <div class="col">
            <input type="hidden" id="pr_block" name="xinput" value="xyz">
            <input type="hidden" id="pr_addr" name="pr_addr" value="">
            <input type="hidden" id="pr_email_addr" name="pr_email_addr" value="{{ rent_pr.email if rent_pr.email
                        else 'example@gmail.com; example2@gmail.com'}}">
            <input type="hidden" id="pr_code" name="pr_code" value="{{ rent_pr.pr_code }}">
            <input type="hidden" id="rent_date" name="rent_date" value="{{ rent_pr.nextrentdate }}">
            <input type="hidden" id="tot_due" name="tot_due"
                   value="{{ rent_pr.rent_gale + rent_pr.arrears + rent_pr.totcharges }}">
            <input type="hidden" id="new_arrears_level" name="new_arrears_level"
                   value="{{ rent_pr.new_arrears_level }}">
            <input type="hidden" id="new_arrears" name="new_arrears" value="{{ rent_pr.arrears + rent_pr.rent_gale }}">
            <input type="hidden" id="charge_total" name="charge_total" value="{{ rent_pr.recovery_charge_amount }}">
            <input type="hidden" id="pr_email" name="pr_email" value="{{ block_email }}">
        </div>
    </div>
</form>
{% endblock %}